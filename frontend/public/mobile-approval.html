<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‚®ä»¶å®¡æ ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        
        .header {
            background: #1976d2;
            color: white;
            padding: 12px 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 4px;
            background: rgba(255,255,255,0.2);
        }
        
        .section {
            background: white;
            margin: 10px;
            border-radius: 8px;
            overflow: visible;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* ğŸ”¥ åŸå§‹é‚®ä»¶åŒºåŸŸçš„ç‰¹æ®Šæ ·å¼ */
        .section.original-email {
            margin-top: 0; /* ğŸ”¥ ç§»é™¤é¡¶éƒ¨é—´è·ï¼Œç´§è´´Header */
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 15px;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ğŸ”¥ å›ºå®šåŸå§‹é‚®ä»¶æ ‡é¢˜æ  */
        .section-header.sticky {
            position: sticky;
            top: 44px; /* ğŸ”¥ è°ƒæ•´ä¸ºé¡¶éƒ¨Headerçš„å®é™…é«˜åº¦ */
            z-index: 90;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px 8px 0 0;
        }
        
        .icon-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-appearance: none;
        }
        
        .icon-btn:active {
            background: #f0f0f0;
        }
        
        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 6px;
        }
        
        .section-content {
            padding: 15px;
        }
        
        .info-row {
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .info-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .info-value {
            color: #333;
            word-break: break-word;
        }
        
        .email-body {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.8;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 10px;
            display: flex;
            gap: 10px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-appearance: none;
        }
        
        .btn-approve {
            background: #4caf50;
            color: white;
        }
        
        .btn-approve:active {
            background: #388e3c;
        }
        
        .btn-reject {
            background: #f44336;
            color: white;
        }
        
        .btn-reject:active {
            background: #d32f2f;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            margin: 15px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“§ é‚®ä»¶å®¡æ ¸</h1>
        <div class="status-badge" id="status">åŠ è½½ä¸­...</div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div id="loadingText">æ­£åœ¨åŠ è½½å®¡æ ¸ä»»åŠ¡...</div>
        <div style="margin-top:15px; font-size:12px; color:#999;" id="debugInfo"></div>
    </div>

    <div id="error" style="display:none;"></div>

    <div id="content" style="display:none;">
        <div class="section original-email">
            <div class="section-header sticky">
                <span>ğŸ“© åŸå§‹é‚®ä»¶</span>
                <div class="btn-group">
                    <button class="icon-btn" id="translateOriginalBtn" onclick="translateOriginal()">
                        ğŸŒ ç¿»è¯‘
                    </button>
                    <button class="icon-btn" id="toggleOriginalBtn" onclick="toggleOriginalContent()">
                        â¬†ï¸ æŠ˜å 
                    </button>
                </div>
            </div>
            <div class="section-content" id="originalEmailContent" style="transition: max-height 0.3s ease-out, opacity 0.3s ease-out; overflow: hidden; padding-top: 60px; margin-top: -60px;">
                <div class="info-row">
                    <div class="info-label">å‘ä»¶äºº</div>
                    <div class="info-value" id="fromEmail"></div>
                </div>
                <div class="info-row">
                    <div class="info-label">ä¸»é¢˜</div>
                    <div class="info-value" id="subject"></div>
                </div>
                <div class="info-row">
                    <div class="info-label">æ—¶é—´</div>
                    <div class="info-value" id="sentAt"></div>
                </div>
                <div class="info-row">
                    <div class="info-label">æ­£æ–‡</div>
                    <div class="email-body" id="originalBody"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <span>ğŸ¤– AIç”Ÿæˆçš„å›å¤</span>
                <div class="btn-group">
                    <button class="icon-btn" id="translateReplyBtn" onclick="translateReply()">
                        ğŸŒ ç¿»è¯‘
                    </button>
                    <button class="icon-btn" onclick="startEdit()">
                        âœï¸ ç¼–è¾‘
                    </button>
                    <button class="icon-btn" onclick="showRegenerateDialog()">
                        ğŸ”„ é‡æ–°ç”Ÿæˆ
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div class="info-row">
                    <div class="info-label">å›å¤ä¸»é¢˜</div>
                    <div class="info-value" id="replySubject"></div>
                </div>
                <div class="info-row">
                    <div class="info-label">å›å¤æ­£æ–‡</div>
                    <div class="email-body" id="replyBody" contenteditable="false"></div>
                    <div style="margin-top:10px; display:none;" id="editActions">
                        <button class="btn btn-approve" onclick="saveEdit()" style="flex:none; padding:8px 16px;">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn btn-reject" onclick="cancelEdit()" style="flex:none; padding:8px 16px; margin-left:10px;">âŒ å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="height: 70px;"></div> <!-- Spacer for fixed buttons -->
    </div>

    <div id="buttons" class="buttons" style="display:none;">
        <button class="btn btn-approve" onclick="handleApprove()">âœ“ é€šè¿‡</button>
        <button class="btn btn-reject" onclick="handleReject()">âœ— æ‹’ç»</button>
    </div>

    <!-- AIé‡æ–°ç”Ÿæˆå¯¹è¯æ¡† -->
    <div id="regenerateDialog" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px;">
        <div style="background:white; border-radius:8px; padding:20px; max-width:500px; margin:50px auto;">
            <h3 style="margin-top:0;">ğŸ”„ AIé‡æ–°ç”Ÿæˆå›å¤</h3>
            <p style="color:#666; font-size:14px;">å‘Šè¯‰AIå¦‚ä½•æ”¹è¿›å›å¤å†…å®¹ï¼š</p>
            <textarea id="regenerateInstruction" rows="4" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px; resize:vertical;"
                placeholder="ä¾‹å¦‚ï¼šä½¿ç”¨æ›´æ­£å¼çš„è¯­æ°”ï¼Œå¢åŠ äº§å“ä¼˜åŠ¿ä»‹ç»"></textarea>
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button class="btn btn-approve" onclick="regenerateReply()" style="flex:1;">ğŸš€ é‡æ–°ç”Ÿæˆ</button>
                <button class="btn btn-reject" onclick="closeRegenerateDialog()" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ä»URLè·å–ä»»åŠ¡ID
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('id') || window.location.hash.match(/\/(\d+)/)?.[1] || '10';
        
        // APIé…ç½®
        // ğŸ”¥ ä¿®å¤ï¼šæ”¯æŒå†…ç½‘è®¿é—®ï¼Œè‡ªåŠ¨æ£€æµ‹APIåœ°å€
        let apiHost = window.location.hostname;
        
        // å¦‚æœæ˜¯localhostï¼Œå°è¯•ä½¿ç”¨å®é™…IPåœ°å€ï¼ˆéœ€è¦å‰ç«¯é…ç½®æˆ–ä»URLå‚æ•°è·å–ï¼‰
        // ä»URLå‚æ•°è·å–APIåœ°å€ï¼Œä¾‹å¦‚ï¼š?api_host=192.168.1.100
        const apiHostParam = urlParams.get('api_host');
        if (apiHostParam) {
            apiHost = apiHostParam;
            console.log('[Init] Using API host from URL param:', apiHost);
        } else if (apiHost === 'localhost' || apiHost === '127.0.0.1') {
            // å°è¯•ä» referer æˆ–ä½¿ç”¨é»˜è®¤åœ°å€
            console.warn('[Init] Warning: Using localhost, may not work on mobile!');
            console.warn('[Init] Please add ?api_host=YOUR_IP to the URL');
        }
        
        const apiUrl = `http://${apiHost}:8001/api/approval_tasks/${taskId}`;
        
        let taskData = null;
        let originalBodyText = '';  // åŸå§‹é‚®ä»¶åŸæ–‡
        let originalBodyTranslated = '';  // åŸå§‹é‚®ä»¶è¯‘æ–‡
        let replyBodyText = '';  // AIå›å¤åŸæ–‡
        let replyBodyTranslated = '';  // AIå›å¤è¯‘æ–‡
        let isOriginalTranslated = false;  // åŸå§‹é‚®ä»¶æ˜¯å¦æ˜¾ç¤ºè¯‘æ–‡
        let isReplyTranslated = false;  // AIå›å¤æ˜¯å¦æ˜¾ç¤ºè¯‘æ–‡
        let isOriginalCollapsed = false;  // åŸå§‹é‚®ä»¶æ˜¯å¦æŠ˜å 

        console.log('[Init] Task ID:', taskId);
        console.log('[Init] API URL:', apiUrl);
        console.log('[Init] User Agent:', navigator.userAgent);
        console.log('[Init] Location:', window.location.href);
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        const debugInfo = document.getElementById('debugInfo');
        debugInfo.innerHTML = `
            Task ID: ${taskId}<br>
            API: ${apiUrl}<br>
            Host: ${apiHost}
        `;

        // åŠ è½½ä»»åŠ¡æ•°æ®
        function loadTask() {
            console.log('[LoadTask] Fetching data...');
            document.getElementById('loadingText').textContent = 'è¿æ¥åç«¯API...';
            
            // æ·»åŠ è¶…æ—¶å¤„ç†
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
            
            fetch(apiUrl, { signal: controller.signal })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('[LoadTask] Response status:', response.status);
                    document.getElementById('loadingText').textContent = `æ”¶åˆ°å“åº”: ${response.status}`;
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('[LoadTask] Data received:', data);
                    document.getElementById('loadingText').textContent = 'è§£ææ•°æ®...';
                    taskData = data;
                    displayTask(data);
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('[LoadTask] Error:', error);
                    
                    let errorMsg = `åŠ è½½å¤±è´¥: ${error.message}<br><br>`;
                    
                    if (error.name === 'AbortError') {
                        errorMsg += 'è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥<br><br>';
                    }
                    
                    errorMsg += `API: ${apiUrl}<br><br>`;
                    errorMsg += `è¯·ç¡®ä¿:<br>`;
                    errorMsg += `1. åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ (http://${apiHost}:8001)<br>`;
                    errorMsg += `2. ç½‘ç»œè¿æ¥æ­£å¸¸<br>`;
                    errorMsg += `3. ä»»åŠ¡ID (${taskId}) å­˜åœ¨<br><br>`;
                    errorMsg += `<strong>è°ƒè¯•ä¿¡æ¯:</strong><br>`;
                    errorMsg += `User Agent: ${navigator.userAgent.substring(0, 50)}...<br>`;
                    errorMsg += `å½“å‰URL: ${window.location.href}`;
                    
                    showError(errorMsg);
                });
        }

        // æ˜¾ç¤ºä»»åŠ¡æ•°æ®
        function displayTask(data) {
            console.log('[DisplayTask] Rendering data...');
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            
            // çŠ¶æ€æ˜ å°„
            const statusMap = {
                'pending': 'â³ å¾…å®¡æ ¸',
                'approved': 'âœ… å·²é€šè¿‡',
                'rejected': 'âŒ å·²æ‹’ç»'
            };
            document.getElementById('status').textContent = statusMap[data.status] || data.status;
            
            // åŸå§‹é‚®ä»¶
            const fromName = data.original_email.from_name || '';
            const fromEmail = data.original_email.from_email || '';
            document.getElementById('fromEmail').textContent = fromName ? `${fromName} <${fromEmail}>` : fromEmail;
            document.getElementById('subject').textContent = data.original_email.subject || '(æ— ä¸»é¢˜)';
            document.getElementById('sentAt').textContent = data.original_email.sent_at || '-';
            
            const originalBody = data.original_email.html_body || data.original_email.body || '(æ— å†…å®¹)';
            originalBodyText = originalBody.replace(/\n/g, '<br>');
            document.getElementById('originalBody').innerHTML = originalBodyText;
            
            // AIå›å¤
            document.getElementById('replySubject').textContent = data.draft_subject || '(æ— ä¸»é¢˜)';
            replyBodyText = data.draft_html || data.draft_body || '(æ— å›å¤å†…å®¹)';
            document.getElementById('replyBody').innerHTML = replyBodyText;
            
            // æ˜¾ç¤ºæŒ‰é’®ï¼ˆä»…å¾…å®¡æ ¸çŠ¶æ€ï¼‰
            if (data.status === 'pending') {
                document.getElementById('buttons').style.display = 'flex';
            }
            
            console.log('[DisplayTask] Render complete');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = `<div class="error">${message}</div>`;
        }

        // é€šè¿‡å®¡æ ¸
        async function handleApprove() {
            if (!confirm('ç¡®è®¤é€šè¿‡æ­¤å®¡æ ¸ä»»åŠ¡ï¼Ÿé‚®ä»¶å°†è‡ªåŠ¨å‘é€ã€‚')) {
                return;
            }
            
            console.log('[Approve] Starting...');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'å¤„ç†ä¸­...';
            
            try {
                const response = await fetch(`http://${apiHost}:8001/api/approval_tasks/${taskId}/approve?approved_by=Mobile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    alert('âœ… å®¡æ ¸é€šè¿‡ï¼é‚®ä»¶å·²è‡ªåŠ¨å‘é€ã€‚');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert(`æ“ä½œå¤±è´¥: ${error}`);
                    btn.disabled = false;
                    btn.textContent = 'âœ“ é€šè¿‡';
                }
            } catch (error) {
                console.error('[Approve] Error:', error);
                alert(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'âœ“ é€šè¿‡';
            }
        }

        // æŠ˜å /å±•å¼€åŸå§‹é‚®ä»¶å†…å®¹
        function toggleOriginalContent() {
            const content = document.getElementById('originalEmailContent');
            const btn = document.getElementById('toggleOriginalBtn');
            
            if (isOriginalCollapsed) {
                // å±•å¼€
                content.style.maxHeight = content.scrollHeight + 'px';
                content.style.opacity = '1';
                btn.textContent = 'â¬†ï¸ æŠ˜å ';
                isOriginalCollapsed = false;
                
                // åŠ¨ç”»å®Œæˆåç§»é™¤maxHeighté™åˆ¶ï¼Œå…è®¸å†…å®¹è‡ªç”±å¢é•¿
                setTimeout(() => {
                    if (!isOriginalCollapsed) {
                        content.style.maxHeight = 'none';
                    }
                }, 300);
            } else {
                // æŠ˜å 
                // å…ˆè®¾ç½®å½“å‰é«˜åº¦ï¼Œç„¶åè¿‡æ¸¡åˆ°0
                content.style.maxHeight = content.scrollHeight + 'px';
                // å¼ºåˆ¶é‡ç»˜
                content.offsetHeight;
                content.style.maxHeight = '0';
                content.style.opacity = '0';
                btn.textContent = 'â¬‡ï¸ å±•å¼€';
                isOriginalCollapsed = true;
            }
        }
        async function handleReject() {
            const reason = prompt('è¯·è¾“å…¥æ‹’ç»åŸå› ï¼ˆå¯é€‰ï¼‰:');
            if (reason === null) return; // ç”¨æˆ·å–æ¶ˆ
            
            console.log('[Reject] Starting...');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'å¤„ç†ä¸­...';
            
            try {
                const url = new URL(`http://${apiHost}:8001/api/approval_tasks/${taskId}/reject`);
                url.searchParams.append('rejected_by', 'Mobile');
                if (reason) {
                    url.searchParams.append('reason', reason);
                }
                
                const response = await fetch(url.toString(), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    alert('âœ… å·²æ‹’ç»');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert(`æ“ä½œå¤±è´¥: ${error}`);
                    btn.disabled = false;
                    btn.textContent = 'âœ— æ‹’ç»';
                }
            } catch (error) {
                console.error('[Reject] Error:', error);
                alert(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'âœ— æ‹’ç»';
            }
        }

        // ç¿»è¯‘åŸå§‹é‚®ä»¶
        async function translateOriginal() {
            const btn = document.getElementById('translateOriginalBtn');
            
            // å¦‚æœå·²ç»ç¿»è¯‘è¿‡ï¼Œåˆ‡æ¢æ˜¾ç¤º
            if (originalBodyTranslated) {
                isOriginalTranslated = !isOriginalTranslated;
                document.getElementById('originalBody').innerHTML = isOriginalTranslated ? originalBodyTranslated : originalBodyText;
                btn.textContent = isOriginalTranslated ? 'ğŸŒ åŸæ–‡' : 'ğŸŒ ç¿»è¯‘';
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å¯ä»¥ç¿»è¯‘
            if (!originalBodyText || !taskData) {
                alert('é‚®ä»¶å†…å®¹è¿˜æœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•');
                return;
            }
            
            // é¦–æ¬¡ç¿»è¯‘
            btn.disabled = true;
            btn.textContent = 'ç¿»è¯‘ä¸­...';
            
            try {
                // ğŸ”¥ ç›´æ¥ä½¿ç”¨å·²ç»æ˜¾ç¤ºçš„HTMLå†…å®¹ï¼Œè€Œä¸æ˜¯ä» taskData ä¸­è·å–
                const content = originalBodyText;
                
                console.log('[TranslateOriginal] ç¿»è¯‘å†…å®¹é•¿åº¦:', content.length);
                console.log('[TranslateOriginal] APIåœ°å€:', `http://${apiHost}:8001/api/ai/translate`);
                
                const response = await fetch(`http://${apiHost}:8001/api/ai/translate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        target_lang: 'zh'
                    })
                });
                
                console.log('[TranslateOriginal] å“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[TranslateOriginal] ç¿»è¯‘æˆåŠŸï¼Œè¯‘æ–‡é•¿åº¦:', result.translated?.length || 0);
                    originalBodyTranslated = result.translated || '';
                    isOriginalTranslated = true;
                    document.getElementById('originalBody').innerHTML = originalBodyTranslated;
                    btn.textContent = 'ğŸŒ åŸæ–‡';
                } else {
                    const errorText = await response.text();
                    console.error('[TranslateOriginal] Error:', errorText);
                    alert('ç¿»è¯‘å¤±è´¥ï¼š' + errorText);
                    btn.textContent = 'ğŸŒ ç¿»è¯‘';
                }
            } catch (error) {
                console.error('[TranslateOriginal] Error:', error);
                alert(`ç¿»è¯‘é”™è¯¯: ${error.message}`);
                btn.textContent = 'ğŸŒ ç¿»è¯‘';
            } finally {
                btn.disabled = false;
            }
        }

        // ç¿»è¯‘AIå›å¤
        async function translateReply() {
            const btn = document.getElementById('translateReplyBtn');
            
            // å¦‚æœå·²ç»ç¿»è¯‘è¿‡ï¼Œåˆ‡æ¢æ˜¾ç¤º
            if (replyBodyTranslated) {
                isReplyTranslated = !isReplyTranslated;
                document.getElementById('replyBody').innerHTML = isReplyTranslated ? replyBodyTranslated : replyBodyText;
                btn.textContent = isReplyTranslated ? 'ğŸŒ åŸæ–‡' : 'ğŸŒ ç¿»è¯‘';
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å¯ä»¥ç¿»è¯‘
            if (!replyBodyText || !taskData) {
                alert('AIå›å¤å†…å®¹è¿˜æœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•');
                return;
            }
            
            // é¦–æ¬¡ç¿»è¯‘
            btn.disabled = true;
            btn.textContent = 'ç¿»è¯‘ä¸­...';
            
            try {
                // ğŸ”¥ ç›´æ¥ä½¿ç”¨å·²ç»æ˜¾ç¤ºçš„HTMLå†…å®¹
                const content = replyBodyText;
                
                console.log('[TranslateReply] ç¿»è¯‘å†…å®¹é•¿åº¦:', content.length);
                console.log('[TranslateReply] APIåœ°å€:', `http://${apiHost}:8001/api/ai/translate`);
                
                const response = await fetch(`http://${apiHost}:8001/api/ai/translate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        target_lang: 'zh'
                    })
                });
                
                console.log('[TranslateReply] å“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('[TranslateReply] ç¿»è¯‘æˆåŠŸï¼Œè¯‘æ–‡é•¿åº¦:', result.translated?.length || 0);
                    replyBodyTranslated = result.translated || '';
                    isReplyTranslated = true;
                    document.getElementById('replyBody').innerHTML = replyBodyTranslated;
                    btn.textContent = 'ğŸŒ åŸæ–‡';
                } else {
                    const errorText = await response.text();
                    console.error('[TranslateReply] Error:', errorText);
                    alert('ç¿»è¯‘å¤±è´¥ï¼š' + errorText);
                    btn.textContent = 'ğŸŒ ç¿»è¯‘';
                }
            } catch (error) {
                console.error('[TranslateReply] Error:', error);
                alert(`ç¿»è¯‘é”™è¯¯: ${error.message}`);
                btn.textContent = 'ğŸŒ ç¿»è¯‘';
            } finally {
                btn.disabled = false;
            }
        }

        // å¼€å§‹ç¼–è¾‘
        function startEdit() {
            const replyBody = document.getElementById('replyBody');
            const editActions = document.getElementById('editActions');
            
            // å¦‚æœæ­£åœ¨æ˜¾ç¤ºè¯‘æ–‡ï¼Œå…ˆåˆ‡æ¢å›åŸæ–‡
            if (isReplyTranslated) {
                replyBody.innerHTML = replyBodyText;
                isReplyTranslated = false;
                document.getElementById('translateReplyBtn').textContent = 'ğŸŒ ç¿»è¯‘';
            }
            
            replyBody.contentEditable = 'true';
            replyBody.style.border = '2px solid #1976d2';
            replyBody.style.background = '#fffbf0';
            replyBody.focus();
            editActions.style.display = 'block';
        }

        // ä¿å­˜ç¼–è¾‘
        async function saveEdit() {
            const replyBody = document.getElementById('replyBody');
            const editActions = document.getElementById('editActions');
            const newContent = replyBody.innerHTML;
            
            try {
                const response = await fetch(`http://${apiHost}:8001/api/approval_tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        draft_body: newContent,
                        draft_html: newContent
                    })
                });
                
                if (response.ok) {
                    replyBodyText = newContent;
                    replyBody.contentEditable = 'false';
                    replyBody.style.border = '1px solid #d9d9d9';
                    replyBody.style.background = 'white';
                    editActions.style.display = 'none';
                    alert('âœ… ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('[SaveEdit] Error:', error);
                alert(`ä¿å­˜é”™è¯¯: ${error.message}`);
            }
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            const replyBody = document.getElementById('replyBody');
            const editActions = document.getElementById('editActions');
            
            replyBody.innerHTML = replyBodyText;
            replyBody.contentEditable = 'false';
            replyBody.style.border = '1px solid #d9d9d9';
            replyBody.style.background = 'white';
            editActions.style.display = 'none';
        }

        // æ˜¾ç¤ºé‡æ–°ç”Ÿæˆå¯¹è¯æ¡†
        function showRegenerateDialog() {
            document.getElementById('regenerateDialog').style.display = 'block';
            document.getElementById('regenerateInstruction').value = '';
        }

        // å…³é—­é‡æ–°ç”Ÿæˆå¯¹è¯æ¡†
        function closeRegenerateDialog() {
            document.getElementById('regenerateDialog').style.display = 'none';
        }

        // AIé‡æ–°ç”Ÿæˆå›å¤
        async function regenerateReply() {
            const instruction = document.getElementById('regenerateInstruction').value;
            const dialog = document.getElementById('regenerateDialog');
            
            if (!instruction.trim()) {
                alert('è¯·è¾“å…¥è°ƒæ•´æŒ‡ä»¤');
                return;
            }
            
            try {
                const response = await fetch(`http://${apiHost}:8001/api/approval_tasks/${taskId}/regenerate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instruction: instruction })
                });
                
                if (response.ok) {
                    alert('âœ… AIé‡æ–°ç”ŸæˆæˆåŠŸï¼');
                    dialog.style.display = 'none';
                    // é‡æ–°åŠ è½½æ•°æ®
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert(`é‡æ–°ç”Ÿæˆå¤±è´¥: ${error}`);
                }
            } catch (error) {
                console.error('[RegenerateReply] Error:', error);
                alert(`ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        loadTask();
    </script>
</body>
</html>
